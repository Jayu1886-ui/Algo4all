# render.yaml for ALGO4ALL Automated Trading Platform

services:
  # --- 1. Main Flask Web Service (Handles HTTP, SocketIO, User Interaction) ---
  - type: web
    runtime: python
    name: algo4all-web
    # ⚠️ REPLACE with your actual repository URL
    repo: https://github.com/Jayu1886-ui/ALGO4ALL 
    branch: main
    # Use 'standard' plan for better performance/concurrency for the web server
    plan: standard
    region: frankfurt # Choose your preferred region
    
    # ⚠️ Use your gunicorn.conf.py and specify the wsgi application entry point
    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      gunicorn -c gunicorn.conf.py wsgi:application
      
    healthCheckPath: /
    
    envVars:
      # Automatically set by Render for the main DB connection
      - key: DATABASE_URL
        fromDatabase:
          name: algo4all-db
          property: connectionString
      
      # Automatically set by Render for the Redis cache/broker connection
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: algo4all-cache
          property: connectionString
      
      # Securely managed static credentials (from your .env)
      - key: FERNET_KEY
        value: D5zUftmYldWzvXpdFkWLxZeyXKYJv66Gn1kTnPCu3qg=
      - key: ENCRYPTION_KEY
        value: D5zUftmYldWzvXpdFkWLxZeyXKYJv66Gn1kTnPCu3qg=
      - key: SECRET_KEY
        generateValue: true # Generate a fresh secret key on Render
      - key: OWNER_API_KEY
        value: "30c68b51-a0a1-4425-8b96-8d5fd1dc5a85"
      - key: OWNER_API_SECRET
        value: "1usslyntpd"
      - key: OWNER_USER_ID
        value: "GLOBAL_TRADER"
      - key: UPSTOX_REDIRECT_URI
        value: "https://algo4all.in/auth/callback"
      
      # STREAMER_ACCESS_TOKEN_FILE is not needed on the web server side
      # and should be handled by the Streamer service or a database/cache lookup.


  # --- 2. Celery Worker Service (Core Trading Logic) ---
  - type: worker
    runtime: python
    name: algo4all-celery-worker
    repo: https://github.com/Jayu1886-ui/ALGO4ALL
    branch: main
    plan: standard # Dedicated worker resources
    region: frankfurt 
    
    # ⚠️ IMPORTANT: Launching Celery with gevent pool as per your bash script
    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      # Clears stale beat schedule and starts the worker
      rm -f celerybeat-schedule*
      celery -A celery_app worker -P gevent -c 8 --loglevel=INFO

    # Inherit necessary credentials from the web service
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: algo4all-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: algo4all-cache
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: SECRET_KEY
      - key: OWNER_API_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_API_KEY
      - key: OWNER_API_SECRET
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_API_SECRET
      - key: FERNET_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: FERNET_KEY
      - key: ENCRYPTION_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: ENCRYPTION_KEY
      - key: OWNER_USER_ID
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_USER_ID

  # --- 3. Celery Beat Service (Task Scheduler) ---
  - type: worker
    runtime: python
    name: algo4all-celery-beat
    repo: https://github.com/Jayu1886-ui/ALGO4ALL
    branch: main
    plan: starter # Can use a smaller plan since it's just a scheduler
    region: frankfurt 

    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      celery -A celery_app beat --loglevel=INFO

    # Inherit ALL same env vars as the Worker Service
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: algo4all-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: algo4all-cache
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: SECRET_KEY
      - key: OWNER_API_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_API_KEY
      - key: OWNER_API_SECRET
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_API_SECRET
      - key: FERNET_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: FERNET_KEY
      - key: ENCRYPTION_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: ENCRYPTION_KEY
      - key: OWNER_USER_ID
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_USER_ID

  # --- 4. Market Data Streamer Service ---
  - type: worker
    runtime: python
    name: algo4all-streamer
    repo: https://github.com/Jayu1886-ui/ALGO4ALL
    branch: main
    plan: starter # Continuous, but low resource usage
    region: frankfurt

    buildCommand: |
      pip install -r requirements.txt
    startCommand: |
      python -m app.tasks.streamer.streamer

    # Inherit ALL same env vars as the Worker Service
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: algo4all-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: algo4all-cache
          property: connectionString
      - key: SECRET_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: SECRET_KEY
      - key: OWNER_API_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_API_KEY
      - key: OWNER_API_SECRET
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_API_SECRET
      - key: FERNET_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: FERNET_KEY
      - key: ENCRYPTION_KEY
        fromService:
          type: web
          name: algo4all-web
          envVarKey: ENCRYPTION_KEY
      - key: OWNER_USER_ID
        fromService:
          type: web
          name: algo4all-web
          envVarKey: OWNER_USER_ID
      # Handle the STREAMER_ACCESS_TOKEN_FILE setting. 
      # Since you're not using a file on Render, the streamer script MUST be modified 
      # to pull the token from the database or cache using OWNER_USER_ID.

  # --- 5. Redis Cache Service (Celery Broker & Cache) ---
  - type: keyvalue
    name: algo4all-cache
    plan: starter
    ipAllowList:
      - source: 0.0.0.0/0
        description: internal services
    maxmemoryPolicy: allkeys-lru

# --- 6. PostgreSQL Database ---
databases:
  - name: algo4all-db
    databaseName: algo4all_db
    user: algo_user
    plan: starter
    region: frankfurt
    ipAllowList: []

