# render.yaml for ALGO4ALL deployment
# ==========================================================
# This config deploys:
# 1. Web service (Flask + Socket.IO via Gunicorn)
# 2. Redis (managed)
# 3. PostgreSQL (managed)
# 4. Celery Worker
# 5. Celery Beat
# 6. Market Data Streamer
# ==========================================================

# -----------------------------
# 1️⃣ Web Service
# -----------------------------
services:
  - type: web
    name: algo4all-web
    env: python
    plan: free
    region: oregon
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn -c gunicorn.conf.py wsgi:application
    envVars:
      - key: FLASK_ENV
        value: production
      - key: REDIS_URL
        value: redis://algo4all-redis:6379/0
      - key: DATABASE_URL
        value: postgres://algo4all-db:5432/algo4all
      - key: SECRET_KEY
        value: "your-secret-key"
      - key: UPSTOX_ACCESS_TOKEN_FILE
        value: access_token.txt
      - key: OTHER_ENV_VAR
        value: value_from_your_dotenv

# -----------------------------
# 2️⃣ Redis Service (Managed)
# -----------------------------
  - type: redis
    name: algo4all-redis
    plan: free
    region: oregon

# -----------------------------
# 3️⃣ PostgreSQL Service (Managed)
# -----------------------------
  - type: postgres
    name: algo4all-db
    plan: free
    region: oregon
    databaseName: algo4all
    user: algo_user
    password: your-db-password

# -----------------------------
# 4️⃣ Celery Worker
# -----------------------------
  - type: worker
    name: algo4all-celery-worker
    env: python
    plan: free
    region: oregon
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A celery_app worker -P gevent -c 8 --loglevel=INFO
    envVars:
      - key: REDIS_URL
        value: redis://algo4all-redis:6379/0
      - key: DATABASE_URL
        value: postgres://algo4all-db:5432/algo4all

# -----------------------------
# 5️⃣ Celery Beat
# -----------------------------
  - type: worker
    name: algo4all-celery-beat
    env: python
    plan: free
    region: oregon
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A celery_app beat --loglevel=INFO
    envVars:
      - key: REDIS_URL
        value: redis://algo4all-redis:6379/0
      - key: DATABASE_URL
        value: postgres://algo4all-db:5432/algo4all

# -----------------------------
# 6️⃣ Market Data Streamer
# -----------------------------
  - type: worker
    name: algo4all-streamer
    env: python
    plan: free
    region: oregon
    buildCommand: pip install -r requirements.txt
    startCommand: python -m app.tasks.streamer.streamer
    envVars:
      - key: REDIS_URL
        value: redis://algo4all-redis:6379/0
      - key: DATABASE_URL
        value: postgres://algo4all-db:5432/algo4all
      - key: UPSTOX_ACCESS_TOKEN_FILE
        value: access_token.txt
