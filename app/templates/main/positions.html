<!-- app/templates/main/positions.html -->
{% extends "base.html" %}

{% block title %}Positions{% endblock %}

{% block content %}
<!-- Main container with the light gray/silver background -->
<div class="min-h-screen bg-gray-200" x-data>

    <!-- Main Content Area with consistent padding -->
    <div class="space-y-4 p-3">

        <!-- 1. Available Funds Card -->
        <div class="rounded-full bg-black p-3 text-center text-xl font-bold text-white shadow-lg">
            Available Funds : 
            <span class="text-cyan-400">₹{{ "%.2f"|format(funds|float) }}</span>
        </div>

        <!-- 2. Live P&L Card -->
        <div class="grid grid-cols-2 items-center rounded-lg bg-black text-white shadow-lg">
            <div class="py-2 text-center">
                <p class="text-lg font-bold text-yellow-500">Live Profit</p>
                <p class="text-lg font-bold text-yellow-500">& Loss</p>
            </div>
            <div class="border-l-2 border-white py-2 text-center text-3xl font-bold">
                <span class="{{ 'text-green-500' if live_pnl >= 0 else 'text-red-500' }}">
                    {% if live_pnl >= 0 %}+{% endif %}{{ "%.2f"|format(live_pnl|float) }}
                </span>
            </div>
        </div>

        <!-- 3. Current Positions Card -->
        <!-- This card is also a button that will toggle the details visibility -->
        <div x-data="{ open: false }" class="rounded-2xl bg-gradient-to-r from-blue-900 via-blue-700 to-yellow-600 p-4 text-white shadow-xl">
            <button @click="open = !open" class="flex w-full items-center justify-between text-left">
                <div>
                    <h2 class="text-xl font-bold text-yellow-400">Current Position</h2>
                    <p class="text-sm text-gray-200">
                        {% if open_positions %}
                            {{ open_positions|length }} open position(s)
                        {% else %}
                            No open positions.
                        {% endif %}
                    </p>
                </div>
                <!-- Chevron icon that rotates based on the 'open' state -->
                <svg class="h-6 w-6 transform text-yellow-400 transition-transform" :class="{ 'rotate-180': open }" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>
            <!-- Collapsible details area -->
            <div x-show="open" x-transition class="mt-4 space-y-4 border-t border-yellow-400/30 pt-4">
                {% for pos in open_positions %}
                    <div class="text-base font-semibold">
                        <p>Symbol : <span class="font-bold">{{ pos.tradingsymbol }}</span></p>
                        <p>Avg. Price : <span class="font-bold">{{ pos.average_price }}</span></p>
                        <p>Quantity : <span class="font-bold">{{ pos.quantity }}</span></p>
                        <p>LTP : <span class="font-bold">{{ pos.last_price }}</span></p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- 4. All Closed Positions Card -->
        <div x-data="{ open: false }" class="rounded-2xl bg-black p-4 text-white shadow-xl">
            <button @click="open = !open" class="flex w-full items-center justify-between text-left">
                 <div>
                    <h2 class="text-xl font-bold text-lime-300">All Closed Position</h2>
                    <p class="text-sm text-gray-400">
                        {% if closed_positions %}
                            {{ closed_positions|length }} closed position(s) today
                        {% else %}
                            No positions have been closed today.
                        {% endif %}
                    </p>
                </div>
                <svg class="h-6 w-6 transform text-lime-300 transition-transform" :class="{ 'rotate-180': open }" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </button>
            <div x-show="open" x-transition class="mt-4 space-y-4 border-t border-lime-300/30 pt-4">
                {% for pos in closed_positions %}
                    <div class="space-y-1 text-base font-semibold {% if not loop.first %}mt-3 border-t border-gray-700 pt-3{% endif %}">
                        <p>Symbol : <span class="font-bold">{{ pos.tradingsymbol }}</span></p>
                        <p>Buy Price : <span class="font-bold">{{ pos.buy_price }}</span></p>
                        <p>Sell Price : <span class="font-bold">{{ pos.sell_price }}</span></p>
                        <p>Quantity : <span class="font-bold">{{ pos.quantity }}</span></p>
                        <p>P/L : <span class="font-bold {{ 'text-green-500' if pos.pnl|float >= 0 else 'text-red-500' }}">₹{{ pos.pnl }}</span></p>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- 5. Square Off Button -->
        <!-- THE ONLY CHANGE IS ADDING THE ID TO THIS FORM TAG -->
        <form id="square-off-form" action="{{ url_for('main.square_off') }}" method="POST" class="pt-2">
            <!-- Confirmation dialog using Alpine.js -->
            <button type="submit" 
                    @click.prevent="if(window.confirm('Are you sure you want to exit all open positions? This action cannot be undone.')) $el.closest('form').submit()"
                    class="w-full rounded-xl bg-gradient-to-r from-pink-700 via-purple-700 to-blue-800 py-3 text-2xl font-bold text-white shadow-lg">
                Exit All Positions Square Off
            </button>
        </form>

    </div>
</div>

<!-- Footer: Sticky navigation bar -->
{% set active_page = 'positions' %}
{% endblock %}